AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Exposed Access Keys Monitor - Delete exposed keys, lookup CloudTrail, notify security.
  
  Security Improvements:
  - Scoped IAM permissions
  - Encrypted SNS topic
  - Python 3.12 runtime
  - Structured JSON logging
  - NoEcho for sensitive parameters

Parameters:
  SlackWebhookURL:
    Type: String
    Description: Slack Webhook URL for notifications (optional, leave empty to skip)
    Default: ""
    NoEcho: true

Globals:
  Function:
    Runtime: python3.12
    Architectures:
      - arm64
    Timeout: 30
    MemorySize: 128
    LoggingConfig:
      LogFormat: JSON
      ApplicationLogLevel: INFO

Resources:
  # Step Functions State Machine
  ExposedKeyStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: ExposedKeyRemediationWorkflow
      Definition:
        StartAt: DeleteAccessKeyPair
        States:
          DeleteAccessKeyPair:
            Type: Task
            Resource: !GetAtt DeleteAccessKeyPair.Arn
            Next: LookupCloudTrailEvents
          LookupCloudTrailEvents:
            Type: Task
            Resource: !GetAtt LookupCloudTrailEvents.Arn
            Next: NotifySecurity
          NotifySecurity:
            Type: Task
            Resource: !GetAtt NotifySecurity.Arn
            End: true
      Events:
        TrustedAdvisorEvent:
          Type: CloudWatchEvent
          Properties: 
            Pattern:
              source: 
                - aws.trustedadvisor
              detail-type: 
                - Trusted Advisor Check Item Refresh Notification
              detail: 
                status: 
                  - ERROR
                check-name:
                  - Exposed Access Keys
            State: ENABLED
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref DeleteAccessKeyPair
        - LambdaInvokePolicy:
            FunctionName: !Ref LookupCloudTrailEvents
        - LambdaInvokePolicy:
            FunctionName: !Ref NotifySecurity

  # Lambda Functions
  DeleteAccessKeyPair:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ExposedKey-DeleteAccessKey
      CodeUri: ../lambda_functions/
      Handler: delete_access_key_pair.lambda_handler
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Sid: DeleteAccessKey
              Effect: Allow
              Action:
                - iam:DeleteAccessKey
              Resource: !Sub 'arn:aws:iam::${AWS::AccountId}:user/*'
 
  LookupCloudTrailEvents:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ExposedKey-LookupCloudTrail
      CodeUri: ../lambda_functions/
      Handler: lookup_cloudtrail_events.lambda_handler
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Sid: CloudTrailLookup
              Effect: Allow
              Action:
                - cloudtrail:LookupEvents
              Resource: '*'  # LookupEvents doesn't support resource-level permissions
 
  NotifySecurity:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ExposedKey-NotifySecurity
      CodeUri: ../lambda_functions/
      Handler: notify_security.lambda_handler
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Environment:
        Variables: 
          TOPIC_ARN: !Ref NotificationTopic
          SlackWebhook_URL: !Ref SlackWebhookURL

  # Encrypted SNS Topic
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties: 
      TopicName: SecurityNotificationTopic
      DisplayName: Security Alerts - Exposed Access Keys
      KmsMasterKeyId: alias/aws/sns  # Enable encryption at rest

  # CloudWatch Log Groups with retention
  DeleteAccessKeyLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${DeleteAccessKeyPair}'
      RetentionInDays: 90

  LookupCloudTrailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${LookupCloudTrailEvents}'
      RetentionInDays: 90

  NotifySecurityLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${NotifySecurity}'
      RetentionInDays: 90

Outputs:
  StateMachineArn:
    Value: !Ref ExposedKeyStepFunction
  NotificationTopicArn:
    Value: !Ref NotificationTopic
